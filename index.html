<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drill Baby Drill</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container">
    <header>
        <h1>Drill baby drill ğŸ“</h1>
        <button id="theme-toggle" class="btn btn-outline">Motyw</button>
    </header>

    <div id="main-menu">
        <div class="card">
            <h2>Twoje Zestawy PytaÅ„</h2>
            <div id="file-list" style="margin: 15px 0;">
                <p style="opacity: 0.6;">Wgraj plik .txt lub .json</p>
            </div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <label for="file-input" class="btn">ğŸ“‚ Importuj (TXT/JSON)</label>
                <input type="file" id="file-input" accept=".txt,.json">
                <button class="btn btn-outline" onclick="exportData()">ğŸ’¾ Eksportuj wszystko</button>
            </div>
        </div>

        <div class="card hidden" id="setup-card">
            <h2 id="selected-set-name">Wybrany: ---</h2>
            <p style="margin-bottom: 15px;">DostÄ™pnych pytaÅ„: <span id="total-questions-count">0</span></p>
            <div class="setup-controls">
                <button class="btn" onclick="startQuiz('sequential')">â–¶ Wszystkie (kolejno)</button>
                <button class="btn" onclick="startQuiz('random')">ğŸ² Losuj:</button>
                <input type="number" id="random-count" min="1">
                <button id="btn-favorites" class="btn btn-warning" onclick="startQuiz('favorites')" disabled>
                    â­ Tylko ulubione (<span id="fav-count">0</span>)
                </button>
            </div>
        </div>
    </div>

    <div id="quiz-interface" class="hidden">
        <div class="card">
            <div style="display: flex; justify-content: space-between; margin-bottom: 15px; opacity: 0.7;">
                <span id="progress-text">Pytanie 1/10</span>
                <span id="score-text" style="font-weight: bold;">Wynik: 0</span>
            </div>
            
            <div class="question-header">
                <div id="question-text" class="question-text">---</div>
                <button id="fav-toggle-btn" class="fav-btn">â˜†</button>
            </div>

            <div id="options-container" class="options-grid"></div>

            <div class="quiz-footer">
                <button class="btn btn-outline" onclick="prevQuestion()" id="prev-btn">â¬… Wstecz</button>
                <button class="btn btn-danger" onclick="exitQuiz()">WyjdÅº</button>
                <button id="next-btn" class="btn" onclick="nextQuestion()">Dalej â¡</button>
            </div>
        </div>
    </div>

    <div id="results-screen" class="hidden">
        <div class="card">
            <h2 style="text-align: center;">Wynik koÅ„cowy</h2>
            <div id="final-score" class="result-score">0%</div>
            <p style="text-align: center; margin-bottom: 20px;" id="final-details">---</p>
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <button id="retry-wrong-btn" class="btn btn-warning hidden" onclick="startRetry()">ğŸ” PowtÃ³rz tylko bÅ‚Ä™dne</button>
                <button class="btn" onclick="location.reload()">ğŸ  Menu gÅ‚Ã³wne</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- CORE DATA ---
    let db = {
        files: JSON.parse(localStorage.getItem('quiz_files')) || {},
        favorites: JSON.parse(localStorage.getItem('quiz_favs')) || []
    };

    let session = {
        pool: [],          // Aktualnie wyÅ›wietlane pytania
        currentIndex: 0,
        score: 0,
        wrongIndices: [],  // Indeksy z 'pool', ktÃ³re byÅ‚y bÅ‚Ä™dne
        answers: [],       // Zapisane odpowiedzi uÅ¼ytkownika: {selectedText, isCorrect}
        displayOptions: [] // ZapamiÄ™tana kolejnoÅ›Ä‡ opcji dla kaÅ¼dego pytania
    };

    // --- PARSOWANIE I IMPORT/EKSPORT ---
    function parseTxt(text) {
        const blocks = text.replace(/--- START OF FILE ---/g, '').trim().split(/\n\s*\n/);
        return blocks.map(block => {
            const lines = block.trim().split('\n');
            let qText = "";
            let options = [];
            lines.forEach(line => {
                if (/^(?:>{3})?\s*[A-Z]\)/.test(line)) {
                    options.push({
                        text: line.replace(/^(?:>{3})?\s*[A-Z]\)\s*/, '').trim(),
                        isCorrect: line.includes('>>>')
                    });
                } else if (options.length === 0) { qText += line + "\n"; }
            });
            return (qText && options.some(o => o.isCorrect)) ? { id: Math.random().toString(36).substr(2, 9), question: qText.trim(), options } : null;
        }).filter(x => x);
    }

    document.getElementById('file-input').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const content = e.target.result;
            if (file.name.endsWith('.json')) {
                try {
                    const data = JSON.parse(content);
                    if (data.files) db.files = {...db.files, ...data.files};
                    if (data.favorites) db.favorites = [...new Set([...db.favorites, ...data.favorites])];
                    saveToDisk();
                } catch(e) { alert("BÅ‚Ä…d pliku JSON"); }
            } else {
                const qs = parseTxt(content);
                if (qs.length) { db.files[file.name] = qs; saveToDisk(); }
            }
            renderFileList();
        };
        reader.readAsText(file);
    });

    function exportData() {
        const data = JSON.stringify(db);
        const blob = new Blob([data], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `quiz_backup_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
    }

    function saveToDisk() {
        localStorage.setItem('quiz_files', JSON.stringify(db.files));
        localStorage.setItem('quiz_favs', JSON.stringify(db.favorites));
    }

    // --- UI RENDERERS ---
    function renderFileList() {
        const list = document.getElementById('file-list');
        list.innerHTML = '';
        Object.keys(db.files).forEach(name => {
            const div = document.createElement('div');
            div.className = 'file-list-item';
            div.innerHTML = `<span>ğŸ“„ ${name} (${db.files[name].length})</span>
                <div><button class="btn btn-small" onclick="selectSet('${name}')">Wybierz</button>
                <button class="btn btn-danger btn-small" onclick="deleteSet('${name}')">ğŸ—‘</button></div>`;
            list.appendChild(div);
        });
    }

    let currentSetName = "";
    function selectSet(name) {
        currentSetName = name;
        const qs = db.files[name];
        document.getElementById('selected-set-name').innerText = `Wybrany: ${name}`;
        document.getElementById('total-questions-count').innerText = qs.length;
        document.getElementById('setup-card').classList.remove('hidden');
        document.getElementById('random-count').value = Math.min(20, qs.length);
        updateFavCount();
    }

    function deleteSet(name) {
        if (confirm("UsunÄ…Ä‡ ten zestaw?")) { delete db.files[name]; saveToDisk(); renderFileList(); }
    }

    function updateFavCount() {
        const count = db.files[currentSetName].filter(q => db.favorites.includes(q.question)).length;
        document.getElementById('fav-count').innerText = count;
        document.getElementById('btn-favorites').disabled = count === 0;
    }

    // --- QUIZ LOGIC ---
    function startQuiz(mode) {
        let pool = [...db.files[currentSetName]];
        if (mode === 'random') {
            const count = parseInt(document.getElementById('random-count').value);
            pool = pool.sort(() => 0.5 - Math.random()).slice(0, count);
        } else if (mode === 'favorites') {
            pool = pool.filter(q => db.favorites.includes(q.question));
        }

        session = { pool, currentIndex: 0, score: 0, wrongIndices: [], answers: [], displayOptions: [] };
        document.getElementById('main-menu').classList.add('hidden');
        document.getElementById('quiz-interface').classList.remove('hidden');
        renderQuestion();
    }

    function startRetry() {
        const newPool = session.wrongIndices.map(i => session.pool[i]);
        session = { pool: newPool, currentIndex: 0, score: 0, wrongIndices: [], answers: [], displayOptions: [] };
        document.getElementById('results-screen').classList.add('hidden');
        document.getElementById('quiz-interface').classList.remove('hidden');
        renderQuestion();
    }

    function renderQuestion() {
        const q = session.pool[session.currentIndex];
        const answered = session.answers[session.currentIndex];

        document.getElementById('progress-text').innerText = `Pytanie ${session.currentIndex + 1}/${session.pool.length}`;
        document.getElementById('score-text').innerText = `Wynik: ${session.score}`;
        document.getElementById('question-text').innerText = q.question;
        
        // Ulubione
        const favBtn = document.getElementById('fav-toggle-btn');
        favBtn.innerText = db.favorites.includes(q.question) ? 'â˜…' : 'â˜†';
        favBtn.className = 'fav-btn' + (db.favorites.includes(q.question) ? ' active' : '');
        favBtn.onclick = () => {
            if (db.favorites.includes(q.question)) db.favorites = db.favorites.filter(x => x !== q.question);
            else db.favorites.push(q.question);
            saveToDisk(); renderQuestion(); updateFavCount();
        };

        // Opcje - zapamiÄ™tujemy kolejnoÅ›Ä‡ przy pierwszym renderowaniu
        if (!session.displayOptions[session.currentIndex]) {
            session.displayOptions[session.currentIndex] = [...q.options].sort(() => 0.5 - Math.random());
        }

        const container = document.getElementById('options-container');
        container.innerHTML = '';
        session.displayOptions[session.currentIndex].forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = opt.text;
            
            if (answered) {
                btn.disabled = true;
                if (opt.isCorrect) btn.classList.add('correct');
                if (answered.selectedText === opt.text && !opt.isCorrect) btn.classList.add('wrong');
            } else {
                btn.onclick = () => handleAnswer(opt.text, opt.isCorrect);
            }
            container.appendChild(btn);
        });

        document.getElementById('next-btn').disabled = !answered;
        document.getElementById('prev-btn').disabled = session.currentIndex === 0;
    }

    function handleAnswer(text, isCorrect) {
        session.answers[session.currentIndex] = { selectedText: text, isCorrect };
        if (isCorrect) session.score++;
        else session.wrongIndices.push(session.currentIndex);
        renderQuestion();
    }

    function nextQuestion() {
        if (session.currentIndex < session.pool.length - 1) {
            session.currentIndex++;
            renderQuestion();
        } else finishQuiz();
    }

    function prevQuestion() {
        if (session.currentIndex > 0) {
            session.currentIndex--;
            renderQuestion();
        }
    }

    function finishQuiz() {
        document.getElementById('quiz-interface').classList.add('hidden');
        document.getElementById('results-screen').classList.remove('hidden');
        const pct = Math.round((session.score / session.pool.length) * 100);
        document.getElementById('final-score').innerText = `${pct}%`;
        document.getElementById('final-details').innerText = `Poprawne: ${session.score} / ${session.pool.length}`;
        
        const retryBtn = document.getElementById('retry-wrong-btn');
        retryBtn.classList.toggle('hidden', session.wrongIndices.length === 0);
        if (session.wrongIndices.length > 0) {
            retryBtn.innerText = `ğŸ” PowtÃ³rz tylko bÅ‚Ä™dne (${session.wrongIndices.length})`;
        }
    }

    function exitQuiz() { if(confirm("PrzerwaÄ‡ quiz?")) location.reload(); }

    // Theme toggle
    document.getElementById('theme-toggle').onclick = () => {
        const isDark = document.body.getAttribute('data-theme') === 'dark';
        document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
        localStorage.setItem('quiz_theme', isDark ? 'light' : 'dark');
    };
    if (localStorage.getItem('quiz_theme') === 'dark') document.body.setAttribute('data-theme', 'dark');

    renderFileList();
</script>
</body>
</html>