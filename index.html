<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drill Baby Drill</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container">
    <header>
        <h1>Quiz Master üéì</h1>
        <button id="theme-toggle" class="btn btn-outline">üåô Motyw</button>
    </header>

    <!-- MENU G≈Å√ìWNE -->
    <div id="main-menu">
        <div class="card">
            <h2>Twoje zestawy pyta≈Ñ</h2>
            <div id="file-list" style="margin-top: 15px;">
                <p style="opacity: 0.6;">Brak wczytanych plik√≥w.</p>
            </div>
            <div style="margin-top: 20px;">
                <label for="file-input" class="btn">üìÇ Wczytaj plik .txt</label>
                <input type="file" id="file-input" accept=".txt">
            </div>
        </div>

        <div class="card hidden" id="setup-card">
            <h2 id="selected-set-name">Wybrany zestaw: Brak</h2>
            <p>Liczba pyta≈Ñ: <span id="total-questions-count">0</span></p>
            
            <div class="setup-controls">
                <button class="btn" onclick="startQuiz('sequential')">‚ñ∂ Wszystkie po kolei</button>
                <div style="display: flex; gap: 5px; flex-grow: 1;">
                    <input type="number" id="random-count" min="1" placeholder="Ile pyta≈Ñ?">
                    <button class="btn" onclick="startQuiz('random')">üé≤ Losuj</button>
                </div>
                <button id="btn-favorites" class="btn btn-warning" onclick="startQuiz('favorites')" disabled>
                    ‚≠ê Tylko ulubione (<span id="fav-count">0</span>)
                </button>
            </div>
        </div>
    </div>

    <!-- QUIZ -->
    <div id="quiz-interface" class="hidden">
        <div class="card">
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px; opacity: 0.7; font-size: 0.9rem;">
                <span id="progress-text">Pytanie 1/10</span>
                <span id="score-text" class="score-badge">Wynik: 0</span>
            </div>
            
            <div class="question-header">
                <div id="question-text" class="question-text">Tre≈õƒá pytania...</div>
                <button id="fav-toggle-btn" class="fav-btn" title="Dodaj do ulubionych">‚òÜ</button>
            </div>

            <div id="options-container" class="options-grid">
                <!-- Opcje generowane JS -->
            </div>
            <div class="quiz-footer">
                <button class="btn btn-danger btn-small" onclick="exitQuiz()">Wyjd≈∫</button>
                <button id="next-btn" class="btn hidden" onclick="nextQuestion()">Nastƒôpne ‚û°</button>
            </div>
        </div>
    </div>

    <!-- WYNIKI -->
    <div id="results-screen" class="hidden">
        <div class="card">
            <h2 style="text-align: center;">Koniec Quizu!</h2>
            <div id="final-score" class="result-score">80%</div>
            <p style="text-align: center;" id="final-details">Poprawne: 8/10</p>
            
            <div class="result-actions">
                <button id="retry-wrong-btn" class="btn btn-warning hidden" onclick="startRetry()">üîÅ Powt√≥rz b≈Çƒôdne</button>
                <button class="btn" onclick="location.reload()">üè† Wr√≥ƒá do menu</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- KONFIGURACJA I ZMIENNE ---
    
    const FILES_KEY = 'quiz_master_files';
    const FAV_KEY = 'quiz_master_favorites'; // Przechowujemy tylko ID ulubionych pyta≈Ñ

    let loadedFiles = JSON.parse(localStorage.getItem(FILES_KEY)) || {};
    let favoriteIds = JSON.parse(localStorage.getItem(FAV_KEY)) || [];
    
    let currentQuizData = [];
    let wrongAnswers = [];
    let currentQuestionIndex = 0;
    let score = 0;
    let selectedQuestions = []; // Pe≈Çna pula wybranego zestawu

    // --- FUNKCJE POMOCNICZE ---

    // Prosta funkcja haszujƒÖca do generowania stabilnych ID z tre≈õci pytania
    // Dziƒôki temu ID jest takie samo nawet po ponownym wczytaniu pliku
    function generateId(str) {
        let hash = 0;
        if (str.length === 0) return hash;
        for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash; // Convert to 32bit integer
        }
        return Math.abs(hash).toString();
    }

    // --- PARSOWANIE ---

    function parseTextToQuiz(text) {
        const cleanText = text.replace(/--- START OF FILE ---/g, '').trim();
        const blocks = cleanText.split(/\n\s*\n/);
        const questions = [];

        blocks.forEach(block => {
            if (!block.trim()) return;

            const lines = block.trim().split('\n');
            let questionText = "";
            let options = [];

            const optionRegex = /^(>{3})?\s*([A-Z])\)/;
            const prefixRemovalRegex = /^(?:>{3})?\s*[A-Z]\)\s*/;

            lines.forEach(line => {
                const match = line.match(optionRegex);
                if (match) {
                    const isCorrect = line.includes('>>>');
                    const cleanContent = line.replace(prefixRemovalRegex, '').trim();
                    options.push({ text: cleanContent, isCorrect: isCorrect });
                } else {
                    if(options.length === 0) {
                        questionText += line + "\n";
                    }
                }
            });

            if (questionText && options.length > 1) {
                const qText = questionText.trim();
                // Generujemy ID na podstawie tre≈õci, aby pamiƒôtaƒá ulubione
                const qId = generateId(qText);

                // Sprawd≈∫ czy jest poprawna odpowied≈∫
                if (options.some(o => o.isCorrect)) {
                    questions.push({
                        id: qId,
                        question: qText,
                        options: options
                    });
                }
            }
        });

        return questions;
    }

    // --- OBS≈ÅUGA PLIK√ìW ---

    const fileInput = document.getElementById('file-input');
    const fileListEl = document.getElementById('file-list');

    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const content = e.target.result;
            const questions = parseTextToQuiz(content);
            
            if (questions.length === 0) {
                alert("Nie uda≈Ço siƒô znale≈∫ƒá pyta≈Ñ w tym pliku.");
                return;
            }

            loadedFiles[file.name] = questions;
            localStorage.setItem(FILES_KEY, JSON.stringify(loadedFiles));
            renderFileList();
            alert(`Wczytano ${questions.length} pyta≈Ñ z pliku ${file.name}`);
        };
        reader.readAsText(file);
        fileInput.value = '';
    });

    function renderFileList() {
        fileListEl.innerHTML = '';
        const filenames = Object.keys(loadedFiles);

        if (filenames.length === 0) {
            fileListEl.innerHTML = '<p style="opacity: 0.6;">Brak wczytanych plik√≥w.</p>';
            return;
        }

        filenames.forEach(name => {
            const div = document.createElement('div');
            div.className = 'file-list-item';
            div.innerHTML = `
                <span>üìÑ ${name} <small>(${loadedFiles[name].length} pyta≈Ñ)</small></span>
                <div>
                    <button class="btn btn-small" onclick="selectSet('${name}')">Wybierz</button>
                    <button class="btn btn-danger btn-small" onclick="deleteSet('${name}')">üóë</button>
                </div>
            `;
            fileListEl.appendChild(div);
        });
    }

    function deleteSet(name) {
        if(confirm(`Czy na pewno usunƒÖƒá "${name}"?`)) {
            delete loadedFiles[name];
            localStorage.setItem(FILES_KEY, JSON.stringify(loadedFiles));
            renderFileList();
            document.getElementById('setup-card').classList.add('hidden');
        }
    }

    function selectSet(name) {
        selectedQuestions = loadedFiles[name];
        document.getElementById('selected-set-name').innerText = `Wybrany: ${name}`;
        document.getElementById('total-questions-count').innerText = selectedQuestions.length;
        document.getElementById('setup-card').classList.remove('hidden');
        
        // Konfiguracja inputu
        const countInput = document.getElementById('random-count');
        countInput.max = selectedQuestions.length;
        countInput.value = Math.min(10, selectedQuestions.length);

        // Obs≈Çuga przycisku ulubionych
        updateFavoritesButton();
    }

    function updateFavoritesButton() {
        // Policz ile pyta≈Ñ z wybranego zestawu jest w ulubionych
        const setFavoritesCount = selectedQuestions.filter(q => favoriteIds.includes(q.id)).length;
        const favBtn = document.getElementById('btn-favorites');
        const favCountSpan = document.getElementById('fav-count');
        
        favCountSpan.innerText = setFavoritesCount;
        favBtn.disabled = setFavoritesCount === 0;
    }

    // --- LOGIKA ULUBIONYCH ---

    function toggleFavorite() {
        const q = currentQuizData[currentQuestionIndex];
        const btn = document.getElementById('fav-toggle-btn');
        
        if (favoriteIds.includes(q.id)) {
            // Usu≈Ñ
            favoriteIds = favoriteIds.filter(id => id !== q.id);
            btn.classList.remove('active');
            btn.innerText = '‚òÜ';
        } else {
            // Dodaj
            favoriteIds.push(q.id);
            btn.classList.add('active');
            btn.innerText = '‚òÖ';
        }
        
        localStorage.setItem(FAV_KEY, JSON.stringify(favoriteIds));
    }

    function updateFavoriteIcon() {
        const q = currentQuizData[currentQuestionIndex];
        const btn = document.getElementById('fav-toggle-btn');
        if (favoriteIds.includes(q.id)) {
            btn.classList.add('active');
            btn.innerText = '‚òÖ';
        } else {
            btn.classList.remove('active');
            btn.innerText = '‚òÜ';
        }
    }

    // --- LOGIKA QUIZU ---

    function initQuizState(questions) {
        currentQuizData = questions;
        currentQuestionIndex = 0;
        score = 0;
        wrongAnswers = []; 
        
        document.getElementById('main-menu').classList.add('hidden');
        document.getElementById('results-screen').classList.add('hidden');
        document.getElementById('quiz-interface').classList.remove('hidden');
        renderQuestion();
    }

    function startQuiz(mode) {
        if (!selectedQuestions || selectedQuestions.length === 0) return;

        let quizSet = [];

        if (mode === 'sequential') {
            quizSet = [...selectedQuestions];
        } else if (mode === 'random') {
            const countInput = document.getElementById('random-count');
            let count = parseInt(countInput.value) || 10;
            count = Math.min(count, selectedQuestions.length);
            
            const shuffled = [...selectedQuestions];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            quizSet = shuffled.slice(0, count);
        } else if (mode === 'favorites') {
            quizSet = selectedQuestions.filter(q => favoriteIds.includes(q.id));
        }

        if (quizSet.length === 0) {
            alert("Brak pyta≈Ñ do wy≈õwietlenia w tym trybie.");
            return;
        }

        initQuizState(quizSet);
    }

    function startRetry() {
        if (wrongAnswers.length === 0) return;
        const retrySet = [...wrongAnswers];
        initQuizState(retrySet);
    }

    function renderQuestion() {
        const q = currentQuizData[currentQuestionIndex];
        document.getElementById('progress-text').innerText = `Pytanie ${currentQuestionIndex + 1}/${currentQuizData.length}`;
        document.getElementById('score-text').innerText = `Wynik: ${score}`;
        document.getElementById('question-text').innerText = q.question;
        
        // Obs≈Çuga gwiazdki
        updateFavoriteIcon();
        document.getElementById('fav-toggle-btn').onclick = toggleFavorite;

        const optsContainer = document.getElementById('options-container');
        optsContainer.innerHTML = '';

        // Tasowanie odpowiedzi
        let optionsToDisplay = [...q.options];
        for (let i = optionsToDisplay.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [optionsToDisplay[i], optionsToDisplay[j]] = [optionsToDisplay[j], optionsToDisplay[i]];
        }

        optionsToDisplay.forEach((opt) => {
            const btn = document.createElement('button');
            btn.className = 'btn option-btn';
            btn.innerText = opt.text;
            btn.onclick = () => handleAnswer(btn, opt.isCorrect);
            optsContainer.appendChild(btn);
        });

        document.getElementById('next-btn').classList.add('hidden');
    }

    function handleAnswer(btn, isCorrect) {
        const buttons = document.querySelectorAll('.option-btn');
        buttons.forEach(b => b.disabled = true);

        if (isCorrect) {
            btn.classList.add('correct');
            score++;
        } else {
            btn.classList.add('wrong');
            wrongAnswers.push(currentQuizData[currentQuestionIndex]);
            
            // Pod≈õwietl poprawnƒÖ
            const correctOptionData = currentQuizData[currentQuestionIndex].options.find(o => o.isCorrect);
            const correctBtn = Array.from(buttons).find(b => b.innerText === correctOptionData.text);
            if(correctBtn) correctBtn.classList.add('correct');
        }

        document.getElementById('score-text').innerText = `Wynik: ${score}`;
        
        const nextBtn = document.getElementById('next-btn');
        nextBtn.innerText = (currentQuestionIndex === currentQuizData.length - 1) ? "Zako≈Ñcz Quiz" : "Nastƒôpne ‚û°";
        nextBtn.classList.remove('hidden');
    }

    function nextQuestion() {
        currentQuestionIndex++;
        if (currentQuestionIndex < currentQuizData.length) {
            renderQuestion();
        } else {
            finishQuiz();
        }
    }

    function finishQuiz() {
        document.getElementById('quiz-interface').classList.add('hidden');
        document.getElementById('results-screen').classList.remove('hidden');
        
        const percentage = Math.round((score / currentQuizData.length) * 100);
        document.getElementById('final-score').innerText = `${percentage}%`;
        document.getElementById('final-details').innerText = `Odpowiedzia≈Çe≈õ poprawnie na ${score} z ${currentQuizData.length} pyta≈Ñ.`;

        const retryBtn = document.getElementById('retry-wrong-btn');
        if (wrongAnswers.length > 0) {
            retryBtn.innerHTML = `üîÅ Powt√≥rz b≈Çƒôdne (${wrongAnswers.length})`;
            retryBtn.classList.remove('hidden');
        } else {
            retryBtn.classList.add('hidden');
        }
    }

    function exitQuiz() {
        if(confirm("Czy na pewno chcesz przerwaƒá quiz?")) {
            location.reload();
        }
    }

    // --- MOTYW I START ---

    const themeToggle = document.getElementById('theme-toggle');
    const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
    
    if (localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && prefersDark)) {
        document.body.setAttribute('data-theme', 'dark');
        themeToggle.innerText = '‚òÄ Motyw';
    }

    themeToggle.addEventListener('click', () => {
        if (document.body.getAttribute('data-theme') === 'dark') {
            document.body.removeAttribute('data-theme');
            localStorage.setItem('theme', 'light');
            themeToggle.innerText = 'üåô Motyw';
        } else {
            document.body.setAttribute('data-theme', 'dark');
            localStorage.setItem('theme', 'dark');
            themeToggle.innerText = '‚òÄ Motyw';
        }
    });

    renderFileList();

</script>
</body>
</html>